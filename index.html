<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ponte en mis Zapatos: El Reto Diario</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="./imgs/sena_verde.webp" type="image/png" sizes="32x32">
<!-- Preload de la imagen principal -->
<link rel="preload" as="image" href="./imgs/00.webp">

<!-- Fuentes (display=swap ya implícito) -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Work+Sans:wght@500&display=swap" rel="stylesheet">

<style>
:root {
  --color-primario:#00BFFF;
  --color-secundario:#F8C548;
  --color-texto:#EAEAEA;
  --color-sombra:rgba(0,0,0,.5);
  --color-fondo-boton:#1B2735;
  --color-fondo-panel:rgba(27,39,53,.45);
  --transition: .45s cubic-bezier(.4,.2,.2,1);
  --max-ancho:800px;
}
* { box-sizing:border-box; }
html,body { margin:0; padding:0; }
body {
  font-family:'Poppins',sans-serif;
  background:radial-gradient(ellipse at bottom,#1B2735 0%,#090A0F 100%);
  color:var(--color-texto);
  min-height:100vh;
  display:flex;
  justify-content:center;
  padding:40px 20px;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}
body.loading .main-container { opacity:0; }
body:not(.loading) .main-container { opacity:1; transition:opacity .6s ease; }

.dynamic-background {
  position:fixed; inset:0; z-index:0; overflow:hidden;
  pointer-events:none;
  opacity:.55;
}

.main-container {
  width:100%; max-width:var(--max-ancho);
  background:var(--color-fondo-panel);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.18);
  border-radius:20px;
  padding:2rem;
  position:relative;
  box-shadow:0 10px 30px var(--color-sombra);
  z-index:2;
  text-align:center;
}

h1,h2 { margin:0; line-height:1.15; }
#character-selection-container h1 { color:var(--color-secundario); font-size:2.4em; }
#character-selection-container h2.subtitle { color:var(--color-secundario); font-size:1.8em; font-family:'Work Sans',sans-serif; margin-top:.4rem; }
#character-selection-container p { font-size:1.05em; line-height:1.65; margin:1.2rem 0 1.4rem; }

.image-block {
  width:100%; height:450px;
  border-radius:14px;
  overflow:hidden;
  position:relative;
  margin-bottom:1.7rem;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  will-change:transform;
  transition:box-shadow .6s;
}
.image-block:hover { box-shadow:0 0 55px #111; }
.image-block img {
  width:100%; height:100%;
  object-fit:cover;
  display:block;
  aspect-ratio:16/9;
  background:#111;
  font-style:italic;
}
.circleLight {
  position:absolute; inset:0;
  background:radial-gradient(circle at 50% 50%,#fff,transparent 60%);
  mix-blend-mode:screen;
  opacity:0;
  transition:opacity .5s;
  pointer-events:none;
}
.image-block:hover .circleLight { opacity:.18; }

#scene-title { color:var(--color-secundario); font-size:2.05em; margin:0 0 1rem; }
#story-text { font-size:1.02em; line-height:1.6; min-height:110px; display:flex; align-items:center; justify-content:center; }

#character-buttons,
#choices-container {
  display:flex; flex-direction:column;
  gap:1rem;
  align-items:center;
  margin-top:1.2rem;
}

.choice-button {
  position:relative;
  width:80%; max-width:480px;
  padding:.85em 2.2em;
  background:#fff;
  color:var(--color-fondo-boton);
  border:none;
  border-radius:.55em;
  text-transform:uppercase;
  font-family:'Work Sans',sans-serif;
  font-weight:500;
  font-size:1.05em;
  letter-spacing:.045em;
  cursor:pointer;
  transition:background var(--transition), color var(--transition), transform .25s ease;
  box-shadow:0 4px 14px -4px rgba(0,0,0,.55);
}
.choice-button span { pointer-events:none; }
.choice-button:hover,
.choice-button:focus-visible {
  background:var(--color-secundario);
  color:#111;
  outline:none;
}
.choice-button:active { transform:scale(.97); }

#reflection-table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:.9em; }
#reflection-table th,#reflection-table td {
  border:2px solid var(--color-primario);
  padding:12px;
  text-align:left;
  vertical-align:top;
}
#reflection-table th { background:var(--color-primario); color:#fff; font-size:1.05em; }
#reflection-table td strong { color:var(--color-secundario); }
.ponte-en-tus-zapatos { background:rgba(27,39,53,.7); font-style:italic; }

.hidden { display:none !important; }

.tools-bar {
  display:flex;
  gap:.75rem;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:1.2rem;
}

.tool-btn {
  background:#1B2735;
  color:var(--color-secundario);
  border:1px solid var(--color-secundario);
  border-radius:.5em;
  padding:.55em 1em;
  font-size:.85em;
  cursor:pointer;
  letter-spacing:.05em;
  transition:background .35s,color .35s,border-color .35s;
}
.tool-btn:hover,
.tool-btn:focus-visible {
  background:var(--color-secundario);
  color:#1B2735;
  outline:none;
}

#preload-progress {
  width:100%; height:6px;
  background:rgba(255,255,255,.15);
  border-radius:4px;
  overflow:hidden;
  margin:10px auto 0;
  position:relative;
  max-width:480px;
}
#preload-progress span {
  display:block;
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--color-primario),var(--color-secundario));
  transition:width .4s ease;
}

#enable-audio { order:2; }
#toggle-preload-log { order:3; }

#preload-log {
  max-height:140px;
  overflow:auto;
  font-size:.7rem;
  font-family:monospace;
  background:#0e151c;
  padding:.5rem .65rem;
  border:1px solid #133445;
  border-radius:6px;
  margin:0 auto;
  text-align:left;
  display:none;
}

@media (max-width:768px){
  body { padding:22px 10px; }
  .image-block { height:250px; }
  #character-selection-container h1 { font-size:1.9em; }
  #character-selection-container h2.subtitle { font-size:1.35em; }
  #scene-title { font-size:1.45em; }
  .choice-button { width:100%; font-size:.95em; }
  #reflection-table { font-size:.78em; }
}

/* Preferencias de usuario: reducir movimiento */
@media (prefers-reduced-motion:reduce){
  .image-block,
  .choice-button { transition:none !important; }
  .image-block:hover .circleLight { opacity:0 !important; }
}
</style>
</head>
<body class="loading">

<!-- Fondo decorativo (simplificado para rendimiento) -->
<div class="dynamic-background" aria-hidden="true">
  <svg width="100%" height="100%" viewBox="0 0 1600 900" preserveAspectRatio="xMidYMid slice">
    <defs>
      <radialGradient id="g1" cx="50%" cy="70%" r="75%">
        <stop offset="0%" stop-color="#1B2735"/>
        <stop offset="100%" stop-color="#090A0F"/>
      </radialGradient>
    </defs>
    <rect width="1600" height="900" fill="url(#g1)"></rect>
    <g stroke="#00BFFF22" stroke-width="2">
      <circle cx="200" cy="160" r="90"/>
      <circle cx="1400" cy="300" r="120"/>
      <circle cx="900" cy="700" r="160"/>
    </g>
  </svg>
</div>

<!-- Selección de personaje -->
<div id="character-selection-container" class="main-container" aria-live="polite">
  <div class="image-block" id="selection-image-block">
    <span class="circleLight"></span>
    <img id="selection-image" src="./imgs/00.webp" alt="Escena introductoria del simulador" loading="eager" decoding="async">
  </div>
  <h1>Ponte en mis zapatos:</h1>
  <h2 class="subtitle">El Reto Diario</h2>
  <p>Estás a punto de iniciar una simulación. Aquí no hay puntos ni ganadores. El objetivo es experimentar, por un momento, los desafíos diarios que enfrentan las personas con discapacidad.</p>

  <div id="character-buttons">
    <button class="choice-button" data-character="juan"><span>El Reto de Juan</span></button>
    <button class="choice-button" data-character="leo"><span>El Reto de Leo</span></button>
    <button class="choice-button" data-character="ana"><span>El Reto de Ana</span></button>
    <button class="choice-button" data-character="sofia"><span>El Reto de Sofía</span></button>
  </div>

  <div class="tools-bar">
    <button id="enable-audio" class="tool-btn" type="button">Activar sonido</button>
    <button id="toggle-preload-log" class="tool-btn" type="button">Ver progreso imágenes</button>
  </div>

  <div id="preload-progress" aria-label="Progreso de precarga de imágenes">
    <span id="preload-bar"></span>
  </div>
  <div id="preload-log" aria-live="off"></div>
</div>

<!-- Contenedor del juego -->
<main id="game-container" class="main-container hidden" aria-live="polite">
  <div class="image-block">
    <span class="circleLight"></span>
    <img id="scene-image" src="" alt="" loading="lazy" decoding="async">
  </div>
  <h1 id="scene-title"></h1>
  <div id="story-text"></div>
  <div id="choices-container"></div>
</main>

<audio id="background-music" preload="none" loop></audio>

<script>
/* ================================
   CONFIGURACIÓN Y DATOS DE HISTORIAS
   ================================ */

const mainTheme = './audio/main_theme.mp3';

const stories = {
  juan: {
    music: './audio/juan_theme.mp3',
    scenes: [
      { id:1, title:"El Reto de Juan", text:"Son las 8:00 a.m. Tu examen final es a las 9:00 a.m. Sales de casa.", image:"./juego_1_ponte_mis_zapatos/juan/img/1.webp", choices:[{text:"Avanzar por el andén", nextSceneId:2}] },
      { id:2, title:"Primera Barrera", text:"A solo una cuadra, un carro bloquea el andén. Es imposible pasar.", image:"./juego_1_ponte_mis_zapatos/juan/img/2.webp", choices:[{text:"Bajar a la calle para rodearlo", nextSceneId:3},{text:"Esperar y pedir ayuda", nextSceneId:4}] },
      { id:3, title:"Ruta Peligrosa", text:"Bajas a la calle. Los carros pasan rápido y te sientes vulnerable. Llegas al paradero, pero has perdido tiempo valioso.", image:"./juego_1_ponte_mis_zapatos/juan/img/3.webp", choices:[{text:"Esperar el bus", nextSceneId:5}] },
      { id:5, title:"Bus Inaccesible", text:"Llega tu ruta, pero es un bus antiguo sin rampa. El conductor te ve y sigue de largo. La frustración es enorme.", image:"./juego_1_ponte_mis_zapatos/juan/img/4.webp", choices:[{text:"Esperar el siguiente bus", nextSceneId:6}] },
      { id:6, title:"Final Desastroso", text:"El siguiente bus tarda 20 minutos en llegar. Cuando por fin subes, ya es demasiado tarde. Has perdido el examen final.", image:"./juego_1_ponte_mis_zapatos/juan/img/noc.webp", choices:[{text:"Ver Reflexión", nextSceneId:7}] },
      { id:7, title:"Reflexión: Exclusión", image:"./juego_1_ponte_mis_zapatos/juan/img/exj.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Juan</th></tr>
        <tr><td><strong>Resultado:</strong><br>Fallaste en tu objetivo por barreras fuera de tu control.</td>
        <td><strong>Causas:</strong><br>• Infraestructura deficiente (andenes, buses).<br>• Falta de empatía y civismo.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>A veces, no importa cuánto te esfuerces, si el sistema no es inclusivo, te deja por fuera. La exclusión es el resultado de un entorno que no está diseñado para todos.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] },
      { id:4, title:"Pidiendo Ayuda", text:"Decides esperar. La primera persona te ignora, pero insistes. Una segunda persona se detiene y te ayuda a pasar de forma segura.", image:"./juego_1_ponte_mis_zapatos/juan/img/7.webp", choices:[{text:"Agradecer y continuar", nextSceneId:8}] },
      { id:8, title:"Un Aliado", text:"La persona que te ayudó se indigna por el carro mal parqueado y decide reportarlo. Juntos llegan al paradero.", image:"./juego_1_ponte_mis_zapatos/juan/img/alj.webp", choices:[{text:"Esperar el bus en compañía", nextSceneId:9}] },
      { id:9, title:"Final Positivo", text:"El primer bus es inaccesible, pero el segundo, que llega rápido, sí tiene rampa. Subes y llegas a tu examen justo a tiempo. La ayuda de una persona marcó la diferencia.", image:"./juego_1_ponte_mis_zapatos/juan/img/fnj.webp", choices:[{text:"Ver Reflexión", nextSceneId:10}] },
      { id:10, title:"Reflexión: El Poder de la Ayuda", image:"./juego_1_ponte_mis_zapatos/juan/img/ayj.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Juan</th></tr>
        <tr><td><strong>Resultado:</strong><br>Lograste tu objetivo a pesar de las dificultades.</td>
        <td><strong>Clave del Éxito:</strong><br>• Tu paciencia y perseverancia.<br>• La empatía y acción de otra persona.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>Las barreras sistémicas son difíciles de superar en solitario. La empatía y la disposición a ayudar de los demás pueden ser el puente que garantiza la inclusión y la igualdad de oportunidades.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] }
    ]
  },
  leo: {
    music:'./audio/leo_theme.mp3',
    scenes:[
      { id:11, title:"El Reto de Leo", text:"Necesitas comprar tres ingredientes. Coges tu bastón y sales de casa.", image:"./juego_1_ponte_mis_zapatos/leo/1.webp", choices:[{text:"Comenzar a caminar", nextSceneId:12}] },
      { id:12, title:"Primera Barrera", text:"Sigues la línea guía del andén, pero tu bastón cae en un hueco. Es una alcantarilla abierta.", image:"./juego_1_ponte_mis_zapatos/leo/2.webp", choices:[{text:"Intentar rodearla por tu cuenta", nextSceneId:13},{text:"Pedir orientación", nextSceneId:14}] },
      { id:13, title:"Rodeando a Ciegas", text:"Te mueves hacia la pared para rodear el peligro, pero te golpeas con una señal de tráfico mal ubicada. Entras al supermercado frustrado.", image:"./juego_1_ponte_mis_zapatos/leo/3.webp", choices:[{text:"Buscar los productos solo", nextSceneId:15}] },
      { id:15, title:"Final Desastroso", text:"Intentas encontrar los productos al tacto. Después de mucho tiempo, llegas a la caja y el cajero te informa que has cogido lasaña y arvejas. Frustrado, decides irte sin nada.", image:"./juego_1_ponte_mis_zapatos/leo/7.webp", choices:[{text:"Ver Reflexión", nextSceneId:16}] },
      { id:16, title:"Reflexión: Falta de Apoyo", image:"./juego_1_ponte_mis_zapatos/leo/8.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Leo</th></tr>
        <tr><td><strong>Resultado:</strong><br>No lograste tu objetivo y te fuiste con las manos vacías.</td>
        <td><strong>Causas:</strong><br>• Entorno físico peligroso e inaccesible.<br>• Falta de sistemas de apoyo en el comercio.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>La falta de accesibilidad (etiquetas, personal capacitado) convierte una tarea simple en una misión imposible, generando dependencia y frustración. La autonomía se pierde.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] },
      { id:14, title:"Pidiendo Ayuda", text:"Te detienes y pides ayuda. Una persona amable te guía para pasar el obstáculo de forma segura y te acompaña hasta la entrada del supermercado.", image:"./juego_1_ponte_mis_zapatos/leo/9.webp", choices:[{text:"Agradecer y entrar", nextSceneId:17}] },
      { id:17, title:"Asistencia Adecuada", text:"Dentro, le pides ayuda a un empleado. Él amablemente te acompaña por los pasillos, te lee las etiquetas y te ayuda a encontrar exactamente lo que necesitabas.", image:"./juego_1_ponte_mis_zapatos/leo/asl.webp", choices:[{text:"Ir a la caja", nextSceneId:18}] },
      { id:18, title:"Final Positivo", text:"Con los productos correctos, pagas sin problemas y sales del supermercado habiendo completado tu tarea de forma eficiente y sintiéndote respetado.", image:"./juego_1_ponte_mis_zapatos/leo/fpl.webp", choices:[{text:"Ver Reflexión", nextSceneId:19}] },
      { id:19, title:"Reflexión: Inclusión Efectiva", image:"./juego_1_ponte_mis_zapatos/leo/ril.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Leo</th></tr>
        <tr><td><strong>Resultado:</strong><br>Completaste tu objetivo con éxito y de forma autónoma.</td>
        <td><strong>Clave del Éxito:</strong><br>• Pedir ayuda cuando fue necesario.<br>• La existencia de personal capacitado y empático.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>La verdadera inclusión no es solo evitar barreras, sino también proporcionar los apoyos adecuados. Una asistencia respetuosa fomenta la independencia y la dignidad.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] }
    ]
  },
  ana: {
    music:'./audio/ana_theme.mp3',
    scenes:[
      { id:20, title:"El Reto de Ana", text:"Eres Ana, una persona sorda. Necesitas ir al banco para consultar sobre un cargo desconocido en tu cuenta.", image:"./juego_1_ponte_mis_zapatos/ana/1.webp", choices:[{text:"Entrar al banco", nextSceneId:21}] },
      { id:21, title:"Llegando al mostrador", text:"Llegas al mostrador. El cajero te habla a través de un vidrio y no puedes leer sus labios. Le indicas que eres sorda.", image:"./juego_1_ponte_mis_zapatos/ana/2.webp", choices:[{text:"Usar lápiz y papel", nextSceneId:22},{text:"Usar una app de intérprete", nextSceneId:23}] },
      { id:22, title:"Barreras de Comunicación", text:"Sacas un cuaderno. La comunicación es lenta y frustrante. La gente en la fila se impacienta. El cajero parece molesto.", image:"./juego_1_ponte_mis_zapatos/ana/3.webp", choices:[{text:"Intentar explicar el problema", nextSceneId:24}] },
      { id:24, title:"Final Desastroso", text:"El cajero no entiende bien tu pregunta escrita, te da una respuesta genérica y atiende a la siguiente persona. Te vas sin resolver tu problema y sintiéndote ignorada.", image:"./juego_1_ponte_mis_zapatos/ana/4.webp", choices:[{text:"Ver Reflexión", nextSceneId:25}] },
      { id:25, title:"Reflexión: Comunicación Rota", image:"./juego_1_ponte_mis_zapatos/ana/5.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Ana</th></tr>
        <tr><td><strong>Resultado:</strong><br>Tu problema no fue resuelto y la experiencia fue negativa.</td>
        <td><strong>Causas:</strong><br>• Falta de canales de comunicación accesibles.<br>• Impaciencia y falta de capacitación del personal.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>La comunicación es un derecho. Cuando las empresas no ofrecen alternativas accesibles (como intérpretes o videollamadas), excluyen activamente a una parte de la población.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] },
      { id:23, title:"Tecnología como Aliada", text:"Sacas tu celular y abres una aplicación de video-interpretación que te conecta con un intérprete de Lengua de Señas.", image:"./juego_1_ponte_mis_zapatos/ana/6.webp", choices:[{text:"Mostrarle el teléfono al cajero", nextSceneId:26}] },
      { id:26, title:"Comunicación Fluida", text:"El cajero se sorprende, pero colabora. A través del intérprete en tu pantalla, tienes una conversación clara y rápida. El cajero entiende tu problema al instante.", image:"./juego_1_ponte_mis_zapatos/ana/7.webp", choices:[{text:"Resolver el problema", nextSceneId:27}] },
      { id:27, title:"Final Positivo", text:"El cajero identifica el cargo, lo corrige y te pide disculpas. Resuelves tu problema eficientemente y te vas sintiéndote satisfecha y empoderada.", image:"./juego_1_ponte_mis_zapatos/ana/8.webp", choices:[{text:"Ver Reflexión", nextSceneId:28}] },
      { id:28, title:"Reflexión: Puentes Tecnológicos", image:"./juego_1_ponte_mis_zapatos/ana/9.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Ana</th></tr>
        <tr><td><strong>Resultado:</strong><br>Resolviste tu problema de forma rápida y autónoma.</td>
        <td><strong>Clave del Éxito:</strong><br>• El uso de tecnología de asistencia.<br>• La disposición del personal para usar un método no tradicional.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>La tecnología puede derribar barreras de comunicación que antes parecían insuperables. Las empresas que adoptan estas herramientas promueven una inclusión real y efectiva.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] }
    ]
  },
  sofia: {
    music:'./audio/sofia_theme.mp3',
    scenes:[
      { id:29, title:"El Reto de Sofía", text:"Vives con ansiedad social. Tu reto: Ir a un centro comercial a reclamar una garantía.", image:"./juego_1_ponte_mis_zapatos/sofia/1.webp", choices:[{text:"Ir al centro comercial", nextSceneId:30}] },
      { id:30, title:"La Entrada", text:"Llegas a la entrada. El ruido, las luces y la multitud de gente te golpean de inmediato. Sientes que tu corazón se acelera.", image:"./juego_1_ponte_mis_zapatos/sofia/2.webp", choices:[{text:"Forzarte a entrar rápidamente", nextSceneId:31},{text:"Tomarte un momento y usar tus audífonos", nextSceneId:32}] },
      { id:31, title:"Sobrecarga Sensorial", text:"Entras de golpe. El caos sensorial es demasiado. Te sientes desorientada y abrumada, tu respiración se agita.", image:"./juego_1_ponte_mis_zapatos/sofia/3.webp", choices:[{text:"Intentar buscar la tienda", nextSceneId:33}] },
      { id:33, title:"Final Desastroso", text:"La sobrecarga se convierte en un ataque de pánico. No puedes pensar con claridad. La única opción es salir del centro comercial lo antes posible, sin lograr tu objetivo.", image:"./juego_1_ponte_mis_zapatos/sofia/4.webp", choices:[{text:"Ver Reflexión", nextSceneId:34}] },
      { id:34, title:"Reflexión: Barreras Invisibles", image:"./juego_1_ponte_mis_zapatos/sofia/5.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Sofía</th></tr>
        <tr><td><strong>Resultado:</strong><br>El entorno te superó y no pudiste completar tu tarea.</td>
        <td><strong>Causas:</strong><br>• Sobrecarga sensorial (ruido, luces, multitud).<br>• La naturaleza invisible de la discapacidad psicosocial.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>Para muchas personas, un entorno “normal” puede ser hostil. La accesibilidad también significa crear espacios sensorialmente amables y tener empatía por las luchas que no se ven.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] },
      { id:32, title:"Estrategia de Afrontamiento", text:"Te detienes un momento. Te pones los audífonos con música tranquila y tomas varias respiraciones profundas. Entras sintiéndote más preparada.", image:"./juego_1_ponte_mis_zapatos/sofia/6.webp", choices:[{text:"Buscar la tienda", nextSceneId:35}] },
      { id:35, title:"Navegando el Entorno", text:"La música te ayuda a bloquear el ruido excesivo. Logras encontrar la tienda y te pones en la fila, concentrándote en tu respiración.", image:"./juego_1_ponte_mis_zapatos/sofia/7.webp", choices:[{text:"Hablar con el empleado", nextSceneId:36}] },
      { id:36, title:"Final Positivo", text:"Cuando llega tu turno, explicas la situación con calma. El empleado es amable y procesa tu garantía sin problemas. Sales del centro comercial sintiéndote orgullosa de haberlo logrado.", image:"./juego_1_ponte_mis_zapatos/sofia/8.webp", choices:[{text:"Ver Reflexión", nextSceneId:37}] },
      { id:37, title:"Reflexión: Autogestión y Empatía", image:"./juego_1_ponte_mis_zapatos/sofia/9.webp",
        text:`<table id="reflection-table"><tr><th colspan="2">Análisis del Reto de Sofía</th></tr>
        <tr><td><strong>Resultado:</strong><br>Completaste tu objetivo con éxito.</td>
        <td><strong>Clave del Éxito:</strong><br>• El uso de estrategias de afrontamiento personalizadas.<br>• Un momento de preparación antes de enfrentar el desafío.</td></tr>
        <tr><td colspan="2" class="ponte-en-tus-zapatos"><strong>Reflexión:</strong><br>Las personas con discapacidad psicosocial a menudo desarrollan herramientas para navegar el mundo. Respetar sus tiempos y procesos es una forma fundamental de empatía y apoyo.</td></tr></table>`,
        choices:[{text:"Elegir otro reto", nextSceneId:'character_select'}] }
    ]
  }
};

/* ================================
   REFERENCIAS DOM
   ================================ */
const selectionContainer = document.getElementById('character-selection-container');
const gameContainer = document.getElementById('game-container');
const characterButtons = document.querySelectorAll('#character-buttons .choice-button');
const sceneImage = document.getElementById('scene-image');
const sceneTitleEl = document.getElementById('scene-title');
const storyTextEl = document.getElementById('story-text');
const choicesEl = document.getElementById('choices-container');
const selectionImage = document.getElementById('selection-image');
const enableAudioBtn = document.getElementById('enable-audio');
const audioEl = document.getElementById('background-music');
const preloadBar = document.getElementById('preload-bar');
const preloadLog = document.getElementById('preload-log');
const togglePreloadLogBtn = document.getElementById('toggle-preload-log');

let audioEnabled = false;
let currentStoryData = null;

/* ================================
   AUDIO
   ================================ */
function playMusic(track){
  if(!audioEnabled) return;
  if(audioEl.getAttribute('data-src') !== track){
    audioEl.setAttribute('data-src', track);
    audioEl.src = track;
  }
  audioEl.play().catch(()=>{ /* Silencioso si el navegador bloquea */ });
}

enableAudioBtn.addEventListener('click', ()=>{
  audioEnabled = true;
  playMusic(mainTheme);
  enableAudioBtn.textContent = 'Sonido Activado';
});

/* ================================
   MOSTRAR ESCENA
   ================================ */
function showScene(sceneId){
  if(sceneId === 'character_select'){
    gameContainer.classList.add('hidden');
    selectionContainer.classList.remove('hidden');
    playMusic(mainTheme);
    return;
  }
  const scene = currentStoryData.scenes.find(s => s.id === sceneId);
  if(!scene){ console.warn('Escena no encontrada:', sceneId); return; }

  if(scene.text.includes('<table')){
    storyTextEl.style.display = 'block';
    storyTextEl.style.minHeight = 'auto';
  } else {
    storyTextEl.style.display = 'flex';
    storyTextEl.style.minHeight = '110px';
  }

  sceneImage.src = scene.image;
  sceneImage.alt = scene.title;
  sceneTitleEl.textContent = scene.title;
  storyTextEl.innerHTML = scene.text;
  choicesEl.innerHTML = '';

  scene.choices.forEach(choice => {
    const btn = document.createElement('button');
    btn.className = 'choice-button';
    btn.innerHTML = `<span>${choice.text}</span>`;
    btn.addEventListener('click', () => showScene(choice.nextSceneId));
    choicesEl.appendChild(btn);
  });

  // Precarga ligera de próximas 3 imágenes
  const idx = currentStoryData.scenes.indexOf(scene);
  const nextSlice = currentStoryData.scenes.slice(idx+1, idx+4);
  nextSlice.forEach(s => { if(s?.image) { const im = new Image(); im.src = s.image; } });
}

/* ================================
   EVENTOS DE SELECCIÓN
   ================================ */
characterButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const character = btn.dataset.character;
    currentStoryData = stories[character];
    selectionContainer.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    playMusic(currentStoryData.music);
    showScene(currentStoryData.scenes[0].id);
  });
});

/* ================================
   EFECTO 3D LIGERO
   ================================ */
const threeDBlocks = document.querySelectorAll('.image-block');
let mouse = { x:0, y:0 };
let target = { x:0, y:0 };

threeDBlocks.forEach(block => {
  block.addEventListener('mousemove', e => {
    const r = block.getBoundingClientRect();
    mouse.x = (e.clientX - r.left) - r.width/2;
    mouse.y = (e.clientY - r.top) - r.height/2;
  });
  block.addEventListener('mouseleave', () => {
    mouse.x = 0; mouse.y = 0;
  });
});

function animate3D(){
  target.x += (mouse.x - target.x)/12;
  target.y += (mouse.y - target.y)/12;
  threeDBlocks.forEach(block => {
    block.style.transform = `translate(${target.x*0.05}px, ${target.y*0.05}px) rotateX(${target.y*0.06}deg) rotateY(${target.x*0.06}deg)`;
    const circle = block.querySelector('.circleLight');
    if(circle){
      const cx = (mouse.x + block.clientWidth/2);
      const cy = (mouse.y + block.clientHeight/2);
      circle.style.background = `radial-gradient(circle at ${cx}px ${cy}px, #fff, transparent 60%)`;
    }
  });
  requestAnimationFrame(animate3D);
}
requestAnimationFrame(animate3D);

/* ================================
   PRE-CARGA GLOBAL DE IMÁGENES (NO BLOQUEANTE)
   ================================ */
const allImagePaths = [];
Object.values(stories).forEach(story => {
  story.scenes.forEach(sc => { if(sc.image) allImagePaths.push(sc.image); });
});
/* Evita duplicados */
const uniqueImages = Array.from(new Set(['./imgs/00.webp', ...allImagePaths]));

/* Barra de progreso */
let loadedCount = 0;
function updateProgress(src, ok=true){
  loadedCount++;
  const pct = Math.round((loadedCount / uniqueImages.length)*100);
  preloadBar.style.width = pct + '%';
  if(preloadLogVisible){
    const line = document.createElement('div');
    line.textContent = (ok?'OK ':'ERR') + ' ' + src;
    preloadLog.appendChild(line);
    preloadLog.scrollTop = preloadLog.scrollHeight;
  }
}

function preloadAllImages(list){
  list.forEach(src => {
    const img = new Image();
    img.onload = () => updateProgress(src,true);
    img.onerror = () => updateProgress(src,false);
    img.decoding = 'async';
    img.loading = 'eager';
    img.src = src;
  });
}
let preloadLogVisible = false;
togglePreloadLogBtn.addEventListener('click', ()=>{
  preloadLogVisible = !preloadLogVisible;
  preloadLog.style.display = preloadLogVisible ? 'block' : 'none';
  togglePreloadLogBtn.textContent = preloadLogVisible ? 'Ocultar progreso imágenes' : 'Ver progreso imágenes';
});

/* Lanza la precarga en segundo plano tras primer frame */
requestAnimationFrame(()=>preloadAllImages(uniqueImages));

/* ================================
   INICIALIZACIÓN
   ================================ */
document.addEventListener('DOMContentLoaded', () => {
  if(selectionImage.complete){
    document.body.classList.remove('loading');
  } else {
    selectionImage.addEventListener('load', ()=> document.body.classList.remove('loading'));
    selectionImage.addEventListener('error', ()=> document.body.classList.remove('loading'));
  }
  // Música principal solo si ya habilitó audio antes de cargar
  playMusic(mainTheme);
});

/* Accesibilidad: permitir volver a selección con tecla Escape */
document.addEventListener('keydown', e=>{
  if(e.key === 'Escape' && !selectionContainer.classList.contains('hidden')){
    // ya está en selección → nada
  } else if(e.key === 'Escape' && !gameContainer.classList.contains('hidden')){
    showScene('character_select');
  }
});
</script>
</body>
</html>